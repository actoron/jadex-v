plugins 
{
    id 'java-library'
    id 'java-test-fixtures'
}

description = 'Publish service feature for Jetty'

group = 'org.activecomponents.jadex'

if(System.getProperty("PUBLISH_SCRIPT_PATH"))
	apply from: System.getProperty("PUBLISH_SCRIPT_PATH")

java
{
	sourceCompatibility = '1.21'
}

repositories
{
	mavenCentral()
}

dependencies
{
	def v = System.getProperty('JADEX_VERSION')?:'+'
	implementation 'org.activecomponents.jadex:common:'+v
	implementation 'org.activecomponents.jadex:collection:'+v
	implementation 'org.activecomponents.jadex:traverser:'+v
	implementation 'org.activecomponents.jadex:javaparser:'+v
	implementation 'org.activecomponents.jadex:core:'+v
	implementation 'org.activecomponents.jadex:execution:'+v
	implementation 'org.activecomponents.jadex:injection:'+v
    implementation 'org.activecomponents.jadex:requiredservice:'+v
    implementation 'org.activecomponents.jadex:publishservice:'+v
    implementation 'org.activecomponents.jadex:providedservice:'+v
	implementation 'org.activecomponents.jadex:serialization:'+v
	
	api 'org.eclipse.jetty:jetty-server:11.0.26'
	api 'org.eclipse.jetty.websocket:websocket-jetty-server:11.0.26'
	
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.15.2'

    testImplementation(testFixtures("org.activecomponents.jadex:publishservice:"+v))
    testImplementation(testFixtures(project))

	testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.0'
	testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.0'
	// required for gradle 9!? https://docs.gradle.org/8.7/userguide/upgrading_version_8.html#test_framework_implementation_dependencies
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

sourceSets {
    testFixtures {
        java.srcDirs = ['src/testFixtures/java']
        resources.srcDirs = ['src/testFixtures/resources']
        compileClasspath += sourceSets.main.output
        runtimeClasspath += sourceSets.main.output
    }
    test {
        compileClasspath += sourceSets.main.output
        runtimeClasspath += sourceSets.main.output
    }
}

tasks.test {
    useJUnitPlatform()
    classpath += sourceSets.testFixtures.output + sourceSets.testFixtures.runtimeClasspath
}

task copyDependencies {
    doLast {
        copy {
            configurations.compileClasspath.each { File file ->
                  if (!file.absolutePath.startsWith(project.rootDir.absolutePath)) {
                    if (file.name.endsWith('.jar'))
                        from file.getParent()
                }
            } 
            into 'build/libs/external-dependencies'
        }
    }
    outputs.upToDateWhen { false }
}
build.dependsOn(copyDependencies)

processResources 
{
    from ('src/main/java') 
    {
        include '**/.system'
    }
}

/*tasks.named('test', Test).configure {
    useJUnitPlatform()

    // FÃ¼ge die eigenen main-Klassen *zum* vorhandenen classpath hinzu (sicher)
    // (wir setzen nicht komplett neu, sondern erweitern)
    classpath = files(sourceSets.main.output) + classpath

    // VM-Debug args (optional)
    jvmArgs += ['-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:5005']

    doFirst {
        println "\n=== FINAL TEST CLASS PATH (${classpath.files.size()} entries) ==="
        classpath.files.each { println "  $it" }
        println "==============================================\n"
    }
}*/
